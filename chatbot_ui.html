<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Agentic RAG Chatbot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    :root{
      --bg1: #0f1724;
      --bg2: #1f2937;
      --card: #111827;
      --accent: #4a69bd;
      --muted: #9ca3af;
      --incoming: #3b5998;
      --outgoing: #0ea5a4;
    }
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto, sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#eee}
    .center-wrap{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }

    /* Chat card */
    .chat-card{
      width: 420px;
      max-width: calc(100% - 40px);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius: 16px;
      box-shadow: 0 12px 30px rgba(2,6,23,0.6);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      border: 1px solid rgba(255,255,255,0.03);
    }
    .chat-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 18px;
      background: rgba(74,105,189,0.12);
      border-bottom:1px solid rgba(255,255,255,0.03);
    }
    .chat-header h2{margin:0;font-size:1.05rem;letter-spacing:0.4px}
    .chat-body{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      height:440px;
    }
    .chat-window{
      flex:1;
      overflow-y:auto;
      padding:6px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .bubble{max-width:80%;padding:10px 12px;border-radius:12px;word-wrap:break-word;}
    .outgoing{align-self:flex-end;background:linear-gradient(90deg,var(--outgoing),#059669);color:#fff;border-bottom-right-radius:4px;}
    .incoming{align-self:flex-start;background:var(--incoming);color:#fff;border-bottom-left-radius:4px;}
    .chat-controls{
      padding:12px;
      border-top:1px solid rgba(255,255,255,0.02);
      display:flex;
      gap:8px;
      align-items:center;
      flex-direction:column;
      background:transparent;
    }
    .file-row{display:flex;gap:8px;width:100%;align-items:center}
    .file-row input[type="file"]{flex:1}
    .file-row button{padding:8px 12px;background:var(--accent);color:white;border:none;border-radius:8px;cursor:pointer}
    .input-row{display:flex;gap:8px;width:100%}
    textarea{flex:1;min-height:44px;max-height:120px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#eee;resize:none}
    .send-btn{padding:10px 14px;background:var(--accent);border:none;color:white;border-radius:8px;cursor:pointer}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:28px;background:rgba(0,0,0,0.6);padding:10px 16px;border-radius:8px;color:#fff;display:none}
    @media (max-width:480px){
      .chat-card{width: 96%}
    }
  </style>
</head>
<body>
  <div class="center-wrap">
    <div class="chat-card" role="region" aria-label="Chatbot">
      <div class="chat-header">
        <h2><i class="fas fa-robot"></i> Agentic RAG Chatbot</h2>
      </div>

      <div class="chat-body">
        <div class="chat-window" id="chatWindow"></div>

        <div class="chat-controls">
          <!-- File upload row -->
          <div class="file-row">
            <input id="fileInput" type="file" accept="application/pdf" />
            <button id="uploadBtn">Upload PDF</button>
          </div>

          <!-- Message input row -->
          <div class="input-row">
            <textarea id="messageInput" placeholder="Type your message..."></textarea>
            <button class="send-btn" id="sendBtn">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const chatWindow = document.getElementById('chatWindow');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const toast = document.getElementById('toast');

    function showToast(msg, timeout=3000){
      toast.textContent = msg;
      toast.style.display = 'block';
      setTimeout(()=> toast.style.display='none', timeout);
    }

    function appendBubble(text, cls){
      const el = document.createElement('div');
      el.className = 'bubble ' + cls;
      el.textContent = text;
      chatWindow.appendChild(el);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    async function sendMessage(){
      const text = messageInput.value.trim();
      if(!text) return;
      appendBubble(text, 'outgoing');
      messageInput.value = '';
      appendBubble('Thinking...', 'incoming');

      try{
        const res = await fetch('/chat', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ message: text })
        });
        const data = await res.json();
        // Replace the last "Thinking..." message with the response
        const incoming = chatWindow.querySelectorAll('.incoming');
        const lastIncoming = incoming[incoming.length - 1];
        if(data.response){
          lastIncoming.textContent = data.response;
        } else if(data.error){
          lastIncoming.textContent = 'Error: ' + data.error;
        } else {
          lastIncoming.textContent = 'No response';
        }
      }catch(err){
        const incoming = chatWindow.querySelectorAll('.incoming');
        const lastIncoming = incoming[incoming.length - 1];
        lastIncoming.textContent = 'Request failed';
        console.error(err);
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e) => {
      if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
    });

    uploadBtn.addEventListener('click', async () => {
      const file = fileInput.files[0];
      if(!file){
        showToast('Choose a PDF first');
        return;
      }

      const fd = new FormData();
      fd.append('file', file);

      showToast('Uploading PDF â€” this may take a few seconds...');
      try{
        const res = await fetch('/upload_pdf', {
          method:'POST',
          body: fd
        });
        const data = await res.json();
        if(res.ok){
          showToast(data.message || 'Uploaded & indexed successfully!');
        } else {
          showToast('Upload failed: ' + (data.error || res.statusText));
        }
      }catch(err){
        console.error(err);
        showToast('Upload error');
      }
    });

    // Insert a polite welcome
    appendBubble('Hello! Upload a PDF to augment my knowledge, or ask a question.', 'incoming');
  </script>
</body>
</html>
